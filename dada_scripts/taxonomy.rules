rule taxonomy_control:
    input:
        expand("sequenceTables/all.OTUs.{tax.}seq.RDS",
        "sequenceTables/all.OTUs.tax.seq.tsv",
        expand("{blast}", blast="sequenceTables/blast_results.tsv" if config['taxonomy']['blast']['do'] else "sequenceTables/all.OTUs.tax.seq.tsv")
    output:
        "taxonomy.done"
    threads: 1
    params:
        runtime="00:10:00",
        mem="8G"
    shell:
        """
        touch {output}
        """

def get_taxonomies(config):
    if config['taxonomy']['decipher']['do'] and config['taxonomy']['mothur']['do']:
        return ["sequenceTables/all.seqTab.RDS","sequenceTables/tax.decipher.RDS","sequenceTables/tax.mothur.tsv"]
    elif config['taxonomy']['decipher']['do'] and not config['taxonomy']['mothur']['do']:
        return ["sequenceTables/all.seqTab.RDS","sequenceTables/tax.decipher.tsv"]
    elif config['taxonomy']['mothur']['do'] and not config['taxonomy']['decipher']['do']:
        return ["sequenceTables/all.seqTab.RDS","sequenceTables/tax.mothur.tsv"]
    else:
        return "sequenceTables/all.seqTab.RDS"

rule taxonomy_to_OTUtab:
    input:
        get_taxonomies(config)
    output:
        "sequenceTables/all.OTUs.tax.seq.tsv",
        "sequenceTables/all.OTUs.tax.seq.RDS"
    threads: 1
    params:
        mem="8G",
        runtime="36:00:00"
    conda: "dada_env_new.yml"
    log: "logs/taxonomy.log"
    message: "Combining taxa and OTU tables {input}."
    script:
        "{config[dada_src]}/add_taxonomy.R"

if config['taxonomy']['decipher']['post_ITSx']:
    rule decipher_taxonomy:
        input:
            "sequenceTables/ITSx.seqs.fasta"
        output:
            "sequenceTables/tax.decipher.tsv",
            "sequenceTables/tax.decipher.RDS"
        threads: 1
        params:
            mem="8G",
            runtime="36:00:00"
        conda: "dada_env_new.yml"
        log: "logs/decipher_taxonomy.log"
        message: "Running decipher on {input}."
        script:
            "{config[dada_src]}/decipher_ID.R"
else:
    rule decipher_taxonomy:
        input:
            "sequenceTables/all.seqs.fasta"
        output:
            "sequenceTables/tax.decipher.tsv", 
            "sequenceTables/tax.decipher.RDS"
        threads: 1
        params:
            mem="8G",
            runtime="36:00:00"
        conda: "dada_env_new.yml"
        log: "logs/decipher_taxonomy.log"
        message: "Running decipher on {input}."
        script:
            "{config[dada_src]}/decipher_ID.R"

if config['taxonomy']['mothur']['post_ITSx']:
    rule mothur_taxonomy:
        input:
            "sequenceTables/ITSx.seqs.fasta"
        output:
            "sequenceTables/tax.mothur.tsv"
        threads: 6
        params:
            mem="8G",
            runtime="12:00:00"
        conda: "dada_env_new.yml"
        log: "logs/mothur_taxonomy.log"
        message: "Running mothur classifier on {input}."
        shell:
            """
            mothur "#set.dir(tempdefault={config[taxonomy][mothur][db_path]});
            classify.seqs(fasta={input}, template={config[taxonomy][mothur][tax_db]}.fasta, taxonomy={config[taxonomy][mothur][tax_db]}.taxonomy, cutoff={config[taxonomy][mothur][cutoff]}, method=wang, processors={threads})"
            """
else:
    rule mothur_taxonomy:
        input:
            "sequenceTables/all.seqs.fasta"
        output:
            "sequenceTables/tax.mothur.tsv"
        threads: 6
        params:
            mem="8G",
            runtime="12:00:00"
        conda: "dada_env_new.yml"
        log: "logs/mothur_taxonomy.log"
        message: "Running mothur classifier on {input}."
        shell:
            """
            mothur "#set.dir(tempdefault={config[taxonomy][mothur][db_path]});
            classify.seqs(fasta={input}, template={config[taxonomy][mothur][tax_db]}.fasta, taxonomy={config[taxonomy][mothur][tax_db]}.taxonomy, cutoff={config[taxonomy][mothur][cutoff]}, method=wang, processors={threads})"
            """

if config['ITSx']['do']:
    rule ITSx:
        input:
            "sequenceTables/all.seqs.fasta"
        output:
            directory("sequenceTables/ITSx_out"),
            "sequenceTables/ITSx.seqs.fasta"
        threads: 12
        params:
            mem="8G",
            runtime="48:00:00"
        log: "logs/ITSx.log"
        conda: "dada_env_new.yml"
        message: "Running ITSx on {input}."
        shell:
            """
            export PERL5LIB={config[dada_lib]}/site_perl/5.26.2/x86_64-linux-thread-multi:$PERL5LIB
            ITSx -i {input} --cpu {threads} --detailed_results T --save_regions {config[ITSx][region]} --graphical F \
            -o {output[0]}/ITSx -N {config[ITSx][min_regions]} -E {config[ITSx][e_val]}
            grep '|F|{config[ITSx][region]}' -A 1 --no-group-separator {output[0]}/ITSx.{config[ITSx][region]}.fasta | sed 's/|.*//' > {output[1]}
            """

if config['taxonomy']['blast']['do']:
    rule prepare_blastn:
        input:
            "sequenceTables/all.OTUs.tax.seq.RDS"
        output:
            "sequenceTables/no_anno.seqs.fasta"
        threads: 1
        params:
            mem="8G",
            runtime="2:00:00"
        log: "logs/prep_blastn.log"
        conda: "dada_env_new.yml"
        message: "Preparing blast: extracting un-annotated sequences."
        script:
            "{config[dada_src]}/prepare_blastn.R"
    if config['taxonomy']['blast']['tax2id'] == "none":
        rule blastn:
            input:
                "sequenceTables/no_anno.seqs.fasta"
            output:
                "sequenceTables/blast_results.tsv"
            threads: 1
            params:
                mem="30G,highmem",
                runtime="48:00:00"
            log: "logs/blastn.log"
            conda: "dada_env_new.yml"
            message: "Running blastn on {input}."
            shell:
                """
                blastn -db {config[taxonomy][blast][db_path]}/{config[taxonomy][blast][tax_db]} \
                 -query {input} -outfmt 7 -out {output} -max_target_seqs 10
                """
    else:
        rule blastn:
            input:
                "sequenceTables/no_anno.seqs.fasta"
            output:
                "sequenceTables/blast_results.tsv"
            threads: 1
            params:
                mem="30G,highmem",
                runtime="48:00:00"
            log: "logs/blastn.log"
            conda: "dada_env_new.yml"
            message: "Running blastn on {input}."
            shell:
                """
                TMPD=$(mktemp -d -t --tmpdir={TMPDIR} 'XXXXXX') 
                blastn -query {input} -db {config[taxonomy][blast][db_path]}/{config[taxonomy][blast][tax_db]} \
                 -out $TMPD/blast_result.{config[taxonomy][blast][tax_db]}.tsv \
                 -evalue {config[taxonomy][blast][e_val]} -max_target_seqs 10 \
                 -outfmt '6 qseqid sseqid pident length mismatch gapopen qstart qend evalue bitscore sgi sacc staxids ssciname scomnames stitle'
                join -1 13 -2 1 -t $'\t' <(sort -k 13 $TMPD/blast_result.{config[taxonomy][blast][tax_db]}.tsv) \
                 {config[taxonomy][blast][tax2id]} | sort -k 2 | \
                 awk -F $'\t' 'BEGIN{{s=2;e=24;OFS=FS}} {{for(i=s;i<=e;i++) printf("%s%s",$(i),OFS);printf("%s%s",$1,"\n")}}' >> {output}
                """



